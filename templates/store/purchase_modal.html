{% load static %}
<!-- Modal -->
<div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-100 w-75">
        <div class="modal-content" id="pm">
            <div class="modal-body">    

                <form method="post" id="purchaseForm" action="/store/">
                {% csrf_token %}

                    <input class="hidden" value="purchase" type="text" name="assort" id="assort">
                    <input class="hidden" value="" type="text" name="itemName" id="itemName">
                    <input class="hidden" value="" type="text" name="category" id="category">
                    <input class="hidden" value="gold" type="text" name="currency" id="purchaseCurrency">
                    
                    <div class="item_img_wrap">
                        <img class="item_img" id="modal_item_image" src="{% static 'img/store/감자.png' %}">
                    </div>
                    
                    <h5 id="modalTitle">title</h5>

                    <div class="priceline"><h5 id="modalPrice"></h5></div>

                    <div class="lastline">
                        <div class="quantity-spinner">
                            <button type="button" onclick="decreaseValue()">–</button>
                            <input type="number" name="quantity" id="quantity" value="1" min="1" readonly>
                            <button type="button" onclick="increaseValue()">+</button>
                        </div>
    
                        <input type="hidden" id="modalTotalPrice" name="totalPrice" value="10" readonly>
    
                        <button type="submit" id="liveToastBtn" data-toggle="popover" data-placement="top" data-content="골드가 부족합니다.">
                            구매
                        </button>
                    </div>
                    
                </form>

            </div>
        </div>
    </div>
</div>


<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    // updateTotalPrice 함수를 교체
    function updateTotalPrice() {
        var quantity = parseInt(document.getElementById('quantity').value, 10);
        // "100 G" 또는 "200 EXP"에서 숫자만 추출
        var price = parseInt(document.getElementById('modalPrice').textContent.split(' ')[0], 10);
        var totalPrice = quantity * price;

        document.getElementById('modalTotalPrice').value = totalPrice;
    }

    function increaseValue() {
        var value = parseInt(document.getElementById('quantity').value, 10);
        value = isNaN(value) ? 1 : value;
        value++;
        document.getElementById('quantity').value = value;
        updateTotalPrice();  // 개수를 올릴 때 총 가격 업데이트
    }

    function decreaseValue() {
        var value = parseInt(document.getElementById('quantity').value, 10);
        value = isNaN(value) ? 1 : value;
        value = value > 1 ? value - 1 : 1; // 최소 값 1
        document.getElementById('quantity').value = value;
        updateTotalPrice();  // 개수를 내릴 때 총 가격 업데이트
    }

    // 모달이 열릴 때 기본값으로 초기화
    $(document).ready(function () {

        $('#confirmAndRefreshBtn').on('click', function () {
        location.reload(); // 즉시 페이지를 새로고침합니다.
    });

        $('#exampleModal1').on('show.bs.modal', function () {
            document.getElementById('quantity').value = 1;
            var initialPrice = document.getElementById('modalPrice').textContent;
            document.getElementById('modalTotalPrice').value = initialPrice;
        });

            // $(document).ready() 내부의 #purchaseForm submit 핸들러를 교체
    $('#purchaseForm').on('submit', function (event) {
        event.preventDefault(); 

        var form = $(this);
        var totalPrice = parseInt(form.find('#modalTotalPrice').val(), 10);
        var currencyType = form.find('#purchaseCurrency').val(); // 'gold' 또는 'exp'
        
        // ❗️ 템플릿에서 EXP 값도 가져옵니다.
        var userGold = parseInt('{{ user2.gold }}', 10);
        var userExp = parseInt('{{ user2.exp }}', 10);
        
        var popoverButton = $('#liveToastBtn');
        var hasEnoughCurrency = false;

        // --- ✨ 화폐 종류에 따른 유효성 검사 ---
        if (currencyType === 'exp') {
            if (totalPrice <= userExp) {
                hasEnoughCurrency = true;
            } else {
                popoverButton.attr('data-content', '경험치(EXP)가 부족합니다.').popover('show');
            }
        } else { // 기본값 'gold'
            if (totalPrice <= userGold) {
                hasEnoughCurrency = true;
            } else {
                popoverButton.attr('data-content', '골드(G)가 부족합니다.').popover('show');
            }
        }
        // ------------------------------------

        if (!hasEnoughCurrency) {
            return; // 화폐가 부족하면 제출 중단
        }

        // AJAX 로직 (이전과 동일)
        $.ajax({
            type: 'POST',
            url: form.attr('action'),
            data: form.serialize(),
            success: function (response) {
                $('#exampleModal1').modal('hide');
                $('#purchaseCompleteModal').modal('show');
            },
            error: function (response) {
                // ❗️ 백엔드에서 보낸 에러 메시지 표시 (선택사항)
                var errorMsg = response.responseJSON ? response.responseJSON.error : '오류가 발생했습니다. 다시 시도해주세요.';
                alert(errorMsg);
            }
        });
    });
        

        // popover 초기화
        $('[data-toggle="popover"]').popover({
            trigger: 'manual', // manual trigger
            animation: true,
            delay: { "show": 500, "hide": 100 }
        });

        // popover 숨기기
        $('[data-toggle="popover"]').on('mouseleave', function () {
            $(this).popover('hide');
        });
    });
</script>
