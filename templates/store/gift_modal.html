{% load static %}
 <!-- Modal -->
  <div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-100 w-75">
      <div class="modal-content" id="gm">
        <div class="modal-body">

          <form method="post" id="giftForm" action="/store/">
            {% csrf_token %}
            <input class="hidden" value="gift" type="text" name="assort" id="assort">
            <input class="hidden" value="" type="text" name="itemName2" id="itemName2">
            <input class="hidden" value="" type="text" name="category2" id="category2">

                    
                    <h5 id="modalTitle2">title</h5>
                    <div class="priceline2"><h5 id="modalPrice2"></h5></div>



            <div class="charselect">
                <div class="charselect_label">선물을 전달할 대상을 선택해주세요</div>
                <select name="receiver" class="receiver_input">
                  <option disabled selected>캐릭터 이름</option>
                  {% for charname in charnames %}
                      <option class="option" value="{{ charname }}">{{ charname }}</option>
                  {% endfor %}
              </select>
              </div>

            <div class="message_box">
              <div class="message_box_info">
                <div class="message_box_info_left">
                  <img src={% static "img/star.png" %}>
                  <div class="message_box_info_label">
                    하단에 메세지를 작성하세요
                  </div>
                </div>
                
                <div class="message_box_info_right">
                    <div class="custom-checkbox-container">
                        
                        <input type="checkbox" id="anonymous" name="anonymous">
                        <label for="anonymous">익명</label> 
                    </div>
                </div>
              </div>

              <textarea id="message" name="message" placeholder="메시지를 입력하세요" class="message-input" maxlength="200"></textarea>
              
            </div>

            <div class="lastline2">
                <div class="quantity-spinner2">
                    <button type="button" onclick="decreaseValue2()">-</button>
                    <input type="number" name="quantity2" id="quantity2" value="1" min="1" readonly>
                    <button type="button" onclick="increaseValue2()">+</button>
                </div>

                <input type="hidden" id="modalTotalPrice2" name="totalPrice2" value="10" readonly>

                <button type="submit" id="liveToastBtn2" data-toggle="popover" data-placement="top" data-content="갈레온이 부족합니다.">
                    선물
                </button>
            </div>
            
          </form>

        </div>
      </div>
    </div>
  </div>



<script>
  function updateTotalPrice2() {
      var quantity = parseInt(document.getElementById('quantity2').value, 10);
      var price = parseInt(document.getElementById('modalPrice2').textContent, 10);
      var totalPrice = quantity * price;

      // 총 가격을 input 요소에 업데이트
      document.getElementById('modalTotalPrice2').value = totalPrice;
  }

  function increaseValue2() {
      var value = parseInt(document.getElementById('quantity2').value, 10);
      value = isNaN(value) ? 1 : value;
      value++;
      document.getElementById('quantity2').value = value;
      updateTotalPrice2();  // 개수를 올릴 때 총 가격 업데이트
  }

  function decreaseValue2() {
      var value = parseInt(document.getElementById('quantity2').value, 10);
      value = isNaN(value) ? 1 : value;
      value = value > 1 ? value - 1 : 1; // 최소 값 1
      document.getElementById('quantity2').value = value;
      updateTotalPrice2();  // 개수를 내릴 때 총 가격 업데이트
  }


  $(document).ready(function () {
    $('#exampleModal2').on('show.bs.modal', function () {
        document.getElementById('quantity2').value = 1;
        var initialPrice2 = document.getElementById('modalPrice2').textContent;
        document.getElementById('modalTotalPrice2').value = initialPrice2;
        $('.receiver_input').prop('selectedIndex', 0); // Select the first (default) option
        $('#anonymous').prop('checked', false);
        $('#message').val('');
    });

    $(document).ready(function () {
    // --- ✅ REPLACE your old '#liveToastBtn2' click event with this ---
    $('#giftForm').on('submit', function (event) {
        // 1. Prevent the default page reload
        event.preventDefault();

        var form = $(this);
        var totalPrice2 = parseInt(form.find('#modalTotalPrice2').val(), 10);
        var userGaleon = parseInt('{{ user2.gold }}', 10);
        var receiver = form.find('.receiver_input').val();

        // --- Validation Checks ---
        if (!receiver) {
            $('#liveToastBtn2').attr('data-content', "선물 대상을 지정하지 않았습니다.").popover('show');
            return;
        }
        if (totalPrice2 > userGaleon) {
            $('#liveToastBtn2').attr('data-content', "골드가 부족합니다.").popover('show');
            return;
        }

        // 2. Send form data using AJAX
        $.ajax({
            type: 'POST',
            url: form.attr('action'), // The URL specified in the form's action attribute
            data: form.serialize(),   // Send all form data

            // 3. On success, hide the old modal and show the new one
            success: function (response) {
                $('#exampleModal2').modal('hide');
                $('#giftCompleteModal').modal('show');
            },

            // 4. On error, show an alert
            error: function (response) {
                alert('오류가 발생했습니다. 다시 시도해주세요.');
                console.error("Gift AJAX Error:", response);
            }
        });
    });

    // --- ✅ Add this click handler for the new confirmation button ---
    $('#giftConfirmBtn').on('click', function() {
        location.reload(); // Reload the page when the user clicks "확인"
    });

    // ... your other $(document).ready() code remains the same ...
});

    // popover 초기화
    $('[data-toggle="popover"]').popover({
        trigger: 'manual', // manual trigger
        animation: true,
        delay: { "show": 500, "hide": 100 }
    });

    // popover 숨기기
    $('[data-toggle="popover"]').on('mouseleave', function () {
        $(this).popover('hide');
    });
});

</script>
