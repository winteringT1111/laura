{% load static %}
 <!-- Modal -->
  <div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-100 w-75">
      <div class="modal-content" id="gm">
        <div class="modal-body">

          <form method="post" id="giftForm" action="/store/">
            {% csrf_token %}
            <input class="hidden" value="gift" type="text" name="assort" id="assort">
            <input class="hidden" value="" type="text" name="itemName2" id="itemName2">
            <input class="hidden" value="" type="text" name="category2" id="category2">
            <input class="hidden" value="gold" type="text" name="currency" id="giftCurrency">

                    
                    <h5 id="modalTitle2">title</h5>
                    <div class="priceline2"><h5 id="modalPrice2"></h5></div>



            <div class="charselect">
                <div class="charselect_label">선물을 전달할 대상을 선택해주세요</div>
                <select name="receiver" class="receiver_input">
                  <option disabled selected>캐릭터 이름</option>
                  {% for charname in charnames %}
                      <option class="option" value="{{ charname }}">{{ charname }}</option>
                  {% endfor %}
              </select>
              </div>

            <div class="message_box">
              <div class="message_box_info">
                <div class="message_box_info_left">
                  <img src={% static "img/star.png" %}>
                  <div class="message_box_info_label">
                    하단에 메세지를 작성하세요
                  </div>
                </div>
                
                <div class="message_box_info_right">
                    <div class="custom-checkbox-container">
                        
                        <input type="checkbox" id="anonymous" name="anonymous">
                        <label for="anonymous">익명</label> 
                    </div>
                </div>
              </div>

              <textarea id="message" name="message" placeholder="메시지를 입력하세요" class="message-input" maxlength="200"></textarea>
              
            </div>

            <div class="lastline2">
                <div class="quantity-spinner2">
                    <button type="button" onclick="decreaseValue2()">-</button>
                    <input type="number" name="quantity2" id="quantity2" value="1" min="1" readonly>
                    <button type="button" onclick="increaseValue2()">+</button>
                </div>

                <input type="hidden" id="modalTotalPrice2" name="totalPrice2" value="10" readonly>

                <button type="submit" id="liveToastBtn2" data-toggle="popover" data-placement="top" data-content="갈레온이 부족합니다.">
                    선물
                </button>
            </div>
            
          </form>

        </div>
      </div>
    </div>
  </div>



<script>
  // updateTotalPrice2 함수를 교체
  function updateTotalPrice2() {
      var quantity = parseInt(document.getElementById('quantity2').value, 10);
      var price = parseInt(document.getElementById('modalPrice2').textContent.split(' ')[0], 10);
      var totalPrice = quantity * price;

      document.getElementById('modalTotalPrice2').value = totalPrice;
  }

  function increaseValue2() {
      var value = parseInt(document.getElementById('quantity2').value, 10);
      value = isNaN(value) ? 1 : value;
      value++;
      document.getElementById('quantity2').value = value;
      updateTotalPrice2();  // 개수를 올릴 때 총 가격 업데이트
  }

  function decreaseValue2() {
      var value = parseInt(document.getElementById('quantity2').value, 10);
      value = isNaN(value) ? 1 : value;
      value = value > 1 ? value - 1 : 1; // 최소 값 1
      document.getElementById('quantity2').value = value;
      updateTotalPrice2();  // 개수를 내릴 때 총 가격 업데이트
  }


  $(document).ready(function () {
    $('#exampleModal2').on('show.bs.modal', function () {
        document.getElementById('quantity2').value = 1;
        var initialPrice2 = document.getElementById('modalPrice2').textContent;
        document.getElementById('modalTotalPrice2').value = initialPrice2;
        $('.receiver_input').prop('selectedIndex', 0); // Select the first (default) option
        $('#anonymous').prop('checked', false);
        $('#message').val('');
    });

    $(document).ready(function () {
    // --- ✅ REPLACE your old '#liveToastBtn2' click event with this ---
    // $(document).ready() 내부의 #giftForm submit 핸들러를 교체
    $('#giftForm').on('submit', function (event) {
        event.preventDefault();

        var form = $(this);
        var totalPrice2 = parseInt(form.find('#modalTotalPrice2').val(), 10);
        var currencyType = form.find('#giftCurrency').val(); // 'gold' 또는 'exp'
        var userGold = parseInt('{{ user2.gold }}', 10);
        var userExp = parseInt('{{ user2.exp }}', 10);
        var receiver = form.find('.receiver_input').val();
        
        var popoverButton = $('#liveToastBtn2');

        // --- 유효성 검사 ---
        if (!receiver) {
            popoverButton.attr('data-content', "선물 대상을 지정하지 않았습니다.").popover('show');
            return;
        }
        
        var hasEnoughCurrency = false;
        if (currencyType === 'exp') {
            if (totalPrice2 <= userExp) {
                hasEnoughCurrency = true;
            } else {
                popoverButton.attr('data-content', '경험치(EXP)가 부족합니다.').popover('show');
            }
        } else {
            if (totalPrice2 <= userGold) {
                hasEnoughCurrency = true;
            } else {
                popoverButton.attr('data-content', '골드(G)가 부족합니다.').popover('show');
            }
        }

        if (!hasEnoughCurrency) {
            return; // 화폐가 부족하면 제출 중단
        }

        // AJAX 로직
        $.ajax({
            type: 'POST',
            url: form.attr('action'),
            data: form.serialize(),
            success: function (response) {
                $('#exampleModal2').modal('hide');
                $('#giftCompleteModal').modal('show');
            },
            error: function (response) {
                var errorMsg = response.responseJSON ? response.responseJSON.error : '오류가 발생했습니다. 다시 시도해주세요.';
                alert(errorMsg);
            }
        });
    });

    // popover 초기화
    $('[data-toggle="popover"]').popover({
        trigger: 'manual', // manual trigger
        animation: true,
        delay: { "show": 500, "hide": 100 }
    });

    // popover 숨기기
    $('[data-toggle="popover"]').on('mouseleave', function () {
        $(this).popover('hide');
    });
});

</script>
