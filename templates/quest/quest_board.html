{% extends "base.html" %}
{% load static %}
{% block head %}
<link rel="stylesheet" type="text/css" href="{% static 'css/quest/quest.css' %}">

{% endblock %}

{% block content %}
<div class="quest-page-container">
    
    <div class="quest-list-container">
        <h3>ì§„í–‰ ì¤‘ì¸ í€˜ìŠ¤íŠ¸</h3>
        {% for item in active_quests %}
            <div class="quest-item"
                 data-title="{{ item.quest.title }}"
                 data-description="{{ item.quest.description|linebreaksbr }}"
                 data-reward-gold="{{ item.quest.reward_gold }}"
                 data-rewards-json='{{ item.rewards_json }}'>
                
                <div class="quest_left">
                    <img src="{% static 'img/event/quest_img' %}.png" class="quest-icon" alt="quest_img">
                    <div class="quest-duration">
                        <span>ë‚¨ì€ ê¸°í•œ: {{ item.remaining_days }}ì¼</span>
                    </div>
                </div>
                 
                <div class="quest-info">
                    <h5>{{ item.quest.title }}</h5>
                    <h6>ì•„ë¥´ì¹´ë””ì•„ ë§ˆì„</h6>
                    <p>â–¶   {{ item.quest.description|truncatewords:10 }}</p>
                </div>
            </div>
        {% endfor %}
    </div>

    {% if can_perform_quest %}
        <a href="{% url 'main:create_quest_log' %}" class="perform-quest-btn">í€˜ìŠ¤íŠ¸ ìˆ˜í–‰</a>
    {% endif %}

    <div class="quest-log-feed">
        {% for log in quest_logs %}
            <div class="log-post">
                <div class="log-head-header">
                    <img src="{% static 'img/charac/' %}{{ log.author.charEngName }}2.png" class="profile-icon" alt="quest_img">
                    <div class="log-header">
                        <h4>{{ log.title }}</h4>
                        <span class="log-meta">
                            {{ log.author.charName }} | ìˆ˜í–‰ í€˜ìŠ¤íŠ¸: {{ log.quest.title }}
                        </span>
                    </div>
                </div>
                
                <div class="log-content">
                    
                    <p>{{ log.content|linebreaksbr }}</p>
                    {% if log.image %}
                        <img src="{{ log.image.url }}" alt="ë¡œê·¸ ì²¨ë¶€ ì´ë¯¸ì§€" class="log-image">
                    {% endif %}
                </div>
                <div class="log-comments">
                    {% for comment in log.comments.all %}
                        <div class="auto-comment">
                            <p>ğŸ“œ {{ comment.comment_text }}</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% empty %}
            <p class="no-logs">ì•„ì§ ì‘ì„±ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
    </div>
</div>


<div id="questModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <span class="close-btn"></span>
        <h3 id="modal-title" class="notseen"></h3>
        <div class="modal-section wow">
            <h4>ë‚´ìš©</h4>
            <p id="modal-description"></p>
        </div>
        <div class="modal-section wow2">
            <h4>ë³´ìƒ</h4>
            <div id="modal-reward-list"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('questModal');
    const closeBtn = modal.querySelector('.close-btn');
    const questItems = document.querySelectorAll('.quest-item');

    // Add a click listener to each quest item in the list
    questItems.forEach(item => {
    item.addEventListener('click', () => {
        const title = item.dataset.title;
        const description = item.dataset.description;
        const rewardGold = parseInt(item.dataset.rewardGold, 10); // ìˆ«ìë¡œ ë³€í™˜
        
        // 1. JSON ë¬¸ìì—´ì„ ê°€ì ¸ì™€ JavaScript ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜
        const rewardsJson = item.dataset.rewardsJson;
        const rewards = JSON.parse(rewardsJson);

        // 2. ëª¨ë‹¬ ë‚´ìš© ì±„ìš°ê¸°
        modal.querySelector('#modal-title').textContent = title;
        modal.querySelector('#modal-description').innerHTML = description;
        
        const rewardListContainer = modal.querySelector('#modal-reward-list');
        rewardListContainer.innerHTML = ''; // ì´ì „ ë‚´ìš© ì´ˆê¸°í™”

        // 3. ë³´ìƒ ëª©ë¡ HTML ë™ì  ìƒì„±
        let hasRewards = false;

        // ê³¨ë“œ ë³´ìƒ ì¶”ê°€
        if (rewardGold > 0) {
            rewardListContainer.innerHTML += `
                <div class="reward-item">
                    <img src="{% static 'img/ê°ˆë ˆì˜¨.png' %}" class="reward-icon" alt="ê³¨ë“œ">
                    <span class="reward-name">ê³¨ë“œ</span>
                    <span class="reward-quantity">x${rewardGold}</span>
                </div>
            `;
            hasRewards = true;
        }

        // ì•„ì´í…œ ë³´ìƒ ì¶”ê°€
        const staticBase = "{% static 'img/store/' %}";

    // ì•„ì´í…œ ë³´ìƒ ì¶”ê°€
    rewards.forEach(reward => {
        rewardListContainer.innerHTML += `
            <div class="reward-item">
                <img src="${staticBase}${reward.name}.png" class="reward-icon" alt="${reward.name}">
                <span class="reward-name">${reward.name}</span>
                <span class="reward-quantity">x${reward.quantity}</span>
            </div>
        `;
        hasRewards = true;
    });

        // ì•„ë¬´ ë³´ìƒë„ ì—†ì„ ê²½ìš°
        if (!hasRewards) {
            rewardListContainer.innerHTML = '<p>ë³´ìƒ ì—†ìŒ</p>';
        }
        
        modal.style.display = 'flex';
    });
});

    // Function to close the modal
    function closeModal() {
        modal.style.display = 'none';
    }

    // Add closing logic to the close button and the background overlay
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (event) => {
        // Close only if the dark background (the overlay itself) is clicked
        if (event.target === modal) {
            closeModal();
        }
    });
});


document.addEventListener("DOMContentLoaded", () => {
    const container = document.querySelector('.quest-page-container');
    if (container) {
        // ì•½ê°„ì˜ ì§€ì—°ì„ ì£¼ì–´ ìì—°ìŠ¤ëŸ½ê²Œ í˜ì´ë“œë‹¤ìš´
        setTimeout(() => {
            container.classList.add('show');
            // ë“±ì¥ í›„ ë‚´ë¶€ë¥¼ ìë™ ìŠ¤í¬ë¡¤
        }, 100);
    }
});


</script>
{% endblock %}