{% extends "base.html" %}

{% load static %}

{% block head %}
<link rel="stylesheet" type="text/css" href="{% static 'css/notice/realm.css' %}">
{% endblock %}

{% block content %}

<a href="/world" class="goback">RETURN</a>

<div class="tab-controls">
    <button class="tab-button active" data-tab="region-tab">
        <span class="star-icon"></span>ì§€ì—­
    </button>
    <button class="tab-button" data-tab="dungeon-tab">
        <span class="star-icon"></span>ë˜ì „
    </button>
</div>

<div id="region-tab" class="tab-content active" style="position: relative; width: 1520px;">
    <button class="carousel-button left region-carousel-button">&#10094;</button>

    <div class="carousel-container region-carousel-container">
        <div class="carousel-track region-carousel-track">
            <div class="card"><a href="/world/realm/novarium"><img class="notice_head" src="{% static 'img/notice/realm/ë…¸ë°”ë¦¬ì›€.png' %}" alt="header"></a></div>
            <div class="card"><a href="/world/realm/belisar"><img class="notice_head" src="{% static 'img/notice/realm/ë²¨ë¦¬ì‚¬ë¥´.png' %}" alt="header"></a></div>
            <div class="card"><a href="/world/realm/zerka"><img class="notice_head" src="{% static 'img/notice/realm/ì œë¥´ì¹´.png' %}" alt="header"></a></div>
            <div class="card"><a href="/world/realm/tarvel"><img class="notice_head" src="{% static 'img/notice/realm/íƒ€ë¥´ë²¨.png' %}" alt="header"></a></div>
            <div class="card"><a href="/world/realm/elysion"><img class="notice_head" src="{% static 'img/notice/realm/ì—˜ë¦¬ì‹œì˜¨.png' %}" alt="header"></a></div>
            <div class="card"><a href="/world/realm/drakus"><img class="notice_head" src="{% static 'img/notice/realm/ë“œë¼ì¿ ìŠ¤.png' %}" alt="header"></a></div>
            <div class="card"><a href="/world/realm/cardin"><img class="notice_head" src="{% static 'img/notice/realm/ì¹´ë¥´ë”˜.png' %}" alt="header"></a></div>
            <div class="card"><a href="/world/realm/necros"><img class="notice_head" src="{% static 'img/notice/realm/ë„¤í¬ë¡œìŠ¤.png' %}" alt="header"></a></div>
            <div class="card"><a href="/world/realm/serapium"><img class="notice_head" src="{% static 'img/notice/realm/ì„¸ë¼í”¼ì›€.png' %}" alt="header"></a></div>
        </div>
    </div>

    <button class="carousel-button right region-carousel-button">&#10095;</button>

    <div class="progress-bar-container">
        <div class="progress-bar region-progress-bar"></div>
    </div>
</div>

<div id="dungeon-tab" class="tab-content" style="position: relative; width: 1520px; display: none;">
    <button class="carousel-button left dungeon-carousel-button">&#10094;</button>

    <div class="carousel-container dungeon-carousel-container">
        <div class="carousel-track dungeon-carousel-track">
            <div class="card"><img class="notice_head" src="{% static 'img/notice/realm/íƒ€ë¥´ë²¨_ë˜ì „.png' %}" alt="header"></div>
            <div class="card"><img class="notice_head" src="{% static 'img/notice/realm/ë²¨ë¦¬ì‚¬ë¥´_ë˜ì „.png' %}" alt="header"></div>
            <div class="card"><img class="notice_head" src="{% static 'img/notice/realm/ì œë¥´ì¹´_ë˜ì „.png' %}" alt="header"></div>
            <div class="card"><img class="notice_head" src="{% static 'img/notice/realm/ì—˜ë¦¬ì‹œì˜¨_ë˜ì „.png' %}" alt="header"></div>
            <div class="card"><img class="notice_head" src="{% static 'img/notice/realm/ë“œë¼ì¿ ìŠ¤_ë˜ì „.png' %}" alt="header"></div>
            <div class="card"><img class="notice_head" src="{% static 'img/notice/realm/ì¹´ë¥´ë”˜_ë˜ì „.png' %}" alt="header"></div>
        </div>
    </div>

    <button class="carousel-button right dungeon-carousel-button">&#10095;</button>

    <div class="progress-bar-container">
        <div class="progress-bar dungeon-progress-bar"></div>
    </div>
</div>



<script>
const carouselIndices = new Map();

/**
 * ì§„í–‰ ë°”ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
 * @param {string} prefix - 'region-' ë˜ëŠ” 'dungeon-'
 * @param {number} currentIndex - í˜„ì¬ ìºëŸ¬ì…€ ì¸ë±ìŠ¤
 * @param {number} totalCards - ì „ì²´ ì¹´ë“œ ìˆ˜
 * @param {number} visibleCards - í•œ ë²ˆì— ë³´ì´ëŠ” ì¹´ë“œ ìˆ˜
 */
function updateProgressBar(prefix, currentIndex, totalCards, visibleCards) {
    const progressBar = document.querySelector(`.${prefix}progress-bar`);
    if (!progressBar) return;

    // ìºëŸ¬ì…€ì´ ì›€ì§ì¼ ìˆ˜ ìˆëŠ” ì´ ë‹¨ê³„ ìˆ˜
    const maxIndex = totalCards - visibleCards;
    
    // í˜„ì¬ ì¸ë±ìŠ¤ë¥¼ ìµœëŒ€ ì¸ë±ìŠ¤ë¡œ ë‚˜ëˆˆ ë¹„ìœ¨ (0ë¶€í„° maxIndexê¹Œì§€)
    const progress = (currentIndex / maxIndex) * 100;

    // ì§„í–‰ ë°” ë„ˆë¹„ ì—…ë°ì´íŠ¸
    progressBar.style.width = `${Math.min(100, progress)}%`;
}


function setupCarousel(prefix) {
    const containerId = prefix + 'tab';
    
    const track = document.querySelector(`#${containerId} .${prefix}carousel-track`);
    const cards = document.querySelectorAll(`#${containerId} .card`);
    const prevButton = document.querySelector(`#${containerId} .${prefix}carousel-button.left`);
    const nextButton = document.querySelector(`#${containerId} .${prefix}carousel-button.right`);
    
    if (track && track.dataset.listenerSet === 'true') {
        // ì´ë¯¸ ë¦¬ìŠ¤ë„ˆê°€ ì„¤ì •ë˜ì—ˆë‹¤ë©´, ì´ˆê¸° ì¸ë±ìŠ¤ë§Œ ë¦¬ì…‹
        carouselIndices.set(track, 0); 
        track.style.transform = 'translateX(0px)';
        // ì§„í–‰ ë°”ë„ ì´ˆê¸°í™”
        updateProgressBar(prefix, 0, cards.length, 4); // 4ëŠ” ë³´ì´ëŠ” ì¹´ë“œ ìˆ˜ (ëŒ€ëµ 1520px / 330px)
        return;
    }

    if (!track || cards.length === 0) return;

    // ì´ˆê¸°í™” ë§ˆí¬
    track.dataset.listenerSet = 'true'; // ë¦¬ìŠ¤ë„ˆ ì„¤ì • í”Œë˜ê·¸ ë³€ê²½
    carouselIndices.set(track, 0); 
    
    const cardWidth = cards[0] ? cards[0].offsetWidth + 30 : 330;
    
    // í•œ ë²ˆì— ë³´ì´ëŠ” ì¹´ë“œ ìˆ˜ ê³„ì‚° (ì •ìˆ˜)
    const visibleCards = Math.floor(track.parentElement.offsetWidth / cardWidth); 
    // ì´ ì´ë™ ê°€ëŠ¥í•œ ë‹¨ê³„ (ì¸ë±ìŠ¤) ìˆ˜
    const maxMoveIndex = cards.length - visibleCards;


    // ì´ˆê¸° ì§„í–‰ ë°” ì„¤ì •
    updateProgressBar(prefix, 0, cards.length, visibleCards); 


    // ì´ì „ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
    prevButton.addEventListener('click', () => {
        let clickIndex = carouselIndices.get(track) || 0; 
        
        if (clickIndex > 0) {
            clickIndex--;
            const move = cardWidth * clickIndex;
            track.style.transform = `translateX(-${move}px)`;
            carouselIndices.set(track, clickIndex);
            
            // ğŸ‘ˆ ì§„í–‰ ë°” ì—…ë°ì´íŠ¸
            updateProgressBar(prefix, clickIndex, cards.length, visibleCards);
        }
    });

    // ë‹¤ìŒ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
    nextButton.addEventListener('click', () => {
        let clickIndex = carouselIndices.get(track) || 0;
        
        const containerWidth = track.parentElement.offsetWidth;
        const trackWidth = track.scrollWidth;
        const maxTranslate = trackWidth - containerWidth + 211; 
        
        const nextMove = cardWidth * (clickIndex + 1);

        if (nextMove < maxTranslate) { 
            clickIndex++;
            track.style.transform = `translateX(-${nextMove}px)`;
            carouselIndices.set(track, clickIndex);
        } else if (clickIndex * cardWidth < maxTranslate) {
            clickIndex++; // ë§ˆì§€ë§‰ ì¸ë±ìŠ¤ë¡œ ê°„ì£¼
            track.style.transform = `translateX(-${maxTranslate}px)`;
            carouselIndices.set(track, maxMoveIndex); // ë§ˆì§€ë§‰ ì¸ë±ìŠ¤ë¡œ ì„¤ì •
        }

        // ğŸ‘ˆ ì§„í–‰ ë°” ì—…ë°ì´íŠ¸
        updateProgressBar(prefix, carouselIndices.get(track), cards.length, visibleCards);
    });
}

// íƒ­ ì „í™˜ ë¡œì§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
const tabButtons = document.querySelectorAll('.tab-button');
const tabContents = document.querySelectorAll('.tab-content');

tabButtons.forEach(button => {
    button.addEventListener('click', () => {
        const targetId = button.dataset.tab;
        const prefix = targetId.split('-')[0] + '-';

        // 1. ëª¨ë“  íƒ­ ë²„íŠ¼ ë° ì½˜í…ì¸  ìƒíƒœ ì´ˆê¸°í™” ë° í™œì„±í™”
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        tabContents.forEach(content => content.classList.remove('active'));
        document.getElementById(targetId).classList.add('active');
        
        // 2. íƒ­ì´ í™œì„±í™”ëœ ì§í›„ì— ìºëŸ¬ì…€ ì„¤ì •/ì¬ì„¤ì • í•¨ìˆ˜ í˜¸ì¶œ (ë„ˆë¹„ ì¬ê³„ì‚°)
        setupCarousel(prefix);

        // 3. íƒ­ ì „í™˜ ì‹œ ìºëŸ¬ì…€ ìœ„ì¹˜ë¥¼ 0ìœ¼ë¡œ ë¦¬ì…‹ (setupCarousel ë‚´ë¶€ì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨)
        const track = document.querySelector(`#${targetId} .carousel-track`);
        if (track) {
            track.style.transform = 'translateX(0px)';
            carouselIndices.set(track, 0); 
        }
    });
});

// DOM ë¡œë“œ ì‹œ ì´ˆê¸° 'region-tab' ìºëŸ¬ì…€ë§Œ ì„¤ì •
document.addEventListener('DOMContentLoaded', () => {
    setupCarousel('region-'); 
    
    // ë˜ì „ íƒ­ì˜ ì§„í–‰ ë°”ê°€ ì•ˆ ë³´ì´ë„ë¡ ì´ˆê¸° ì„¤ì •
    updateProgressBar('dungeon-', 0, 7, 4); // ì´ 7ê°œ ì¹´ë“œ ì¤‘ 4ê°œ ë³´ì¸ë‹¤ê³  ê°€ì •
});
</script>


{% endblock %}