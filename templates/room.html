{% extends "base.html" %}
{% load static %}

{% block head %}
    <meta charset="UTF-8">
    <title>ìŠ¤í† ë¦¬ ì±•í„°</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/story.css' %}">
    <script>
  (function(d) {
    var config = {
      kitId: 'baa3wec',
      scriptTimeout: 3000,
      async: true
    },
    h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
  })(document);
</script>

{% endblock %}

    
{% block content %}

    <div class="story-container">
        <div class="story-details-panel">
            <div id="story-view-container"></div>
            <img id="chapter-image" src="{% static 'img/chap.png' %}" alt="ì±•í„° ì´ë¯¸ì§€">
            
            <div class="info-box">
                <h1 id="chapter-title">Chapter 01. íƒœì´ˆì˜ ë§ˆì„, ì•„ë¥´ì¹´ë””ì•„ì— ê´€í•˜ì—¬</h1>
                <p id="chapter-summary">
                    ê³¼ê±°ì˜ ìœ„ê·¸ë“œë¼ì‹¤ì€ ëˆ„êµ¬ì—ê²Œë‚˜ í‰ë“±í•˜ê²Œ í–‰ë™í•´ì•¼ë§Œ í–ˆë‹¤.
                    ëˆ„êµ¬ í•˜ë‚˜ ìš°ëŒ€í•´ì„œëŠ” ì•ˆ ë˜ì—ˆê³ , ì¸ê°„ë“¤ì€ ì„±ìŠ¤ëŸ¬ìš´ ë‚˜ë¬´ì˜ ì¡´ì¬ ìì²´ì— ëª©ì ì„ ë‚¨ê¸°ë©´ ì•ˆëë‹¤.
                    ì•„ì´ë“¤ì€ ë¿Œë¦¬ ìœ„ì—ì„œ ë›°ë†€ì•˜ê³ , ì—°ì¸ë“¤ì€ ì€ì€í•œ ì•¼ê´‘ ì´ë¼ ì•„ë˜ì—ì„œ ì‚¬ë‘ì„ ì†ì‚­ì˜€ë‹¤.
                </p>
                <a href="/story/1" id="read-more-link" class="read-more-btn">
                    ìŠ¤í† ë¦¬ ì—´ëŒ
                </a>
            </div>
        </div>

        <div class="chapter-list-panel">

    <div class="chapter-scroll-list">

        <h2 class="section-header">âœ¶  MAINSTORY</h2>
        {% for chapter in main_stories %}
            <div class="chapter-card 
                {% if forloop.first %}active{% endif %}
                 {% if chapter.id in completed_chapter_ids %}completed{% endif %}"   {# ì™„ë£Œí–ˆë‹¤ë©´ completed #}
                 
                 style="background-image: url('{{ chapter.list_image.url }}')"
                 data-chapter-id="{{ chapter.id }}" 
                 data-title="{{ chapter.title }}"
                 data-summary="{{ chapter.summary }}"
                 data-image-src="{{ chapter.background_image.url }}"> {# ğŸ‘ˆ ìŠ¤í† ë¦¬ ì—´ëŒ ì‹œ ë°°ê²½ì´ ë  ì´ë¯¸ì§€ #}
                
                <div class="chapter-overlay">
                    {# ì±•í„° ë²ˆí˜¸ë¥¼ í•­ìƒ ë‘ ìë¦¬ë¡œ í‘œì‹œ (ì˜ˆ: 1 -> 01) #}
                    <h3>CHAPTER {{ chapter.chapter_number|stringformat:"02d" }}</h3>
                    <p>{{ chapter.subtitle }}</p>
                </div>
            </div>
        {% endfor %}

        <h2 class="section-header">âœ¶  SUBSTORY</h2>
        {% for chapter in sub_stories %}
            <div class="chapter-card
                 {% if not main_stories and forloop.first %}active{% endif %} {# ë©”ì¸ ìŠ¤í† ë¦¬ê°€ ì—†ì„ ë•Œë§Œ ì²« ë²ˆì§¸ì— active #}
                 {% if chapter.id in completed_chapter_ids %}completed{% endif %}"
                 
                 style="background-image: url('{{ chapter.list_image.url }}')"
                 data-chapter-id="{{ chapter.id }}" 
                 data-title="{{ chapter.title }}"
                 data-summary="{{ chapter.summary }}"
                 data-image-src="{{ chapter.background_image.url }}">
                
                <div class="chapter-overlay">
                    <h3>CHAPTER {{ chapter.chapter_number|stringformat:"02d" }}</h3>
                    <p>{{ chapter.subtitle }}</p>
                </div>
            </div>
        {% endfor %}
        
    </div>
</div>
    </div>



<script>
document.addEventListener('DOMContentLoaded', () => {
    // 1. í•„ìš”í•œ ëª¨ë“  HTML ìš”ì†Œë¥¼ ìŠ¤í¬ë¦½íŠ¸ ìµœìƒë‹¨ì—ì„œ í•œ ë²ˆë§Œ ì°¾ì•„ ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.
    const storyContainer = document.querySelector('.story-container');
    const storyViewContainer = document.getElementById('story-view-container');
    const chapterCards = document.querySelectorAll('.chapter-card');
    const chapterImage = document.getElementById('chapter-image');
    const chapterTitle = document.getElementById('chapter-title');
    const chapterSummary = document.getElementById('chapter-summary');
    const readMoreLink = document.getElementById('read-more-link');

    let currentChapterId = null; // âœ… í˜„ì¬ ì„ íƒëœ ì±•í„° IDë¥¼ ì €ì¥í•  ë³€ìˆ˜

    // --- ì±•í„° ì¹´ë“œ ì„ íƒ ë¡œì§ ---
    function updateDetails(card) {
        const chapterId = card.dataset.chapterId;
        const title = card.dataset.title;
        const summary = card.dataset.summary;
        const imageSrc = card.dataset.imageSrc;

        currentChapterId = chapterId; // âœ… í´ë¦­ëœ ì¹´ë“œì˜ IDë¥¼ ë³€ìˆ˜ì— ì €ì¥

        chapterImage.src = imageSrc;
        chapterTitle.textContent = title;
        chapterSummary.textContent = summary;
        readMoreLink.href = `/story/${chapterId}`;
    }

    chapterCards.forEach(card => {
        card.addEventListener('click', () => {
            chapterCards.forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            updateDetails(card);
        });
    });

    // âœ…âœ…âœ… ì´ ë¶€ë¶„ì´ ë¹ ì ¸ìˆì—ˆìŠµë‹ˆë‹¤! âœ…âœ…âœ…
    // í˜ì´ì§€ê°€ ì²˜ìŒ ë¡œë“œë  ë•Œ, ê¸°ë³¸ìœ¼ë¡œ 'active' í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ì¹´ë“œë¥¼ ì°¾ì•„ ë‚´ìš©ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    const initialActiveCard = document.querySelector('.chapter-card.active');
    if (initialActiveCard) {
        updateDetails(initialActiveCard);
    }

    // --- ë¹„ì£¼ì–¼ ë…¸ë¸” ì´ˆê¸°í™” ë° ë³´ìƒ ìš”ì²­ ë¡œì§ ---
    function initializeVisualNovel(container) {
        // --- START OF DEBUGGING VERSION ---
    console.log("--- 1. Initializing Visual Novel ---");

    // Step 1: Find the script tag by its ID
    const scriptElement = document.getElementById('script-data');
    console.log("--- 2. Found script tag element:", scriptElement);

    if (!scriptElement) {
        console.error("CRITICAL ERROR: Could not find the <script> tag with ID 'script-data'. Make sure it's in your story_partial.html file.");
        return; // Stop the function if the tag isn't found
    }

    // Step 2: Get the text content from that tag
    const rawJsonString = scriptElement.textContent;
    console.log("--- 3. Raw JSON string from tag:", rawJsonString);

    // Step 3: Parse the string into a JavaScript object
    let scriptData;
    try {
        scriptData = JSON.parse(rawJsonString);
        console.log("--- 4. Successfully parsed data:", scriptData);
    } catch (e) {
        console.error("CRITICAL ERROR: Failed to parse JSON. The data might be malformed.", e);
        return; // Stop if parsing fails
    }

    // Step 4: Find the elements to put the text into
    const nameBox = container.querySelector("#char-name");
    const textBox = container.querySelector("#char-text");
    const nextBtn = container.querySelector("#next-btn");
    console.log("--- 5. Found display elements:", { nameBox, textBox, nextBtn });
    // --- END OF DEBUGGING VERSION ---

        let index = 0;
        let typing = false;
        let typingTimeout;

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function claimRewardAndReload() {
            fetch('/room/claim_reward/', { // âœ… URLì€ ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ í™•ì¸í•´ì£¼ì„¸ìš”.
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                // âœ… ì–´ë–¤ ì±•í„°ë¥¼ ì™„ë£Œí–ˆëŠ”ì§€ IDë¥¼ bodyì— ë‹´ì•„ ë³´ëƒ…ë‹ˆë‹¤.
                body: JSON.stringify({ chapter_id: currentChapterId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' || data.status === 'already_claimed') {
                    location.reload();
                } else {
                    alert('ë³´ìƒì„ ë°›ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function showNextLine() {
        if (typing) {
            completeLine();
            return;
        }

        if (index < scriptData.length) {
            const currentLine = scriptData[index];

            nameBox.textContent = currentLine.name;
            // â—ï¸ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ë¡œì§ì„ ì—¬ê¸°ì„œ ì™„ì „íˆ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.
            
            textBox.innerHTML = ""; // innerHTML ì‚¬ìš©ì€ ìœ ì§€
            typeWriter(currentLine.text, 0);
            index++;
        } else {
            // ìŠ¤í† ë¦¬ ë ë¡œì§ (ë²„íŠ¼ ë³€ê²½)
            nextBtn.disabled = false;
            nextBtn.textContent = "ì²˜ìŒìœ¼ë¡œ";
            nextBtn.removeEventListener("click", showNextLine);
            nextBtn.addEventListener("click", claimRewardAndReload);

            // â—ï¸ ìŠ¤í† ë¦¬ ëë‚  ë•Œ ì´ë¯¸ì§€ ìˆ¨ê¸°ëŠ” ë¡œì§ë„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.
        }
    }

    function typeWriter(text, i) {
        typing = true;
        if (i < text.length) {
            // âœ… Change textContent to innerHTML
            textBox.innerHTML += text.charAt(i);
            typingTimeout = setTimeout(() => typeWriter(text, i + 1), 40);
        } else {
            typing = false;
        }
    }

    // This function also needs the same change
    function completeLine() {
        clearTimeout(typingTimeout);
        // âœ… Change textContent to innerHTML
        textBox.innerHTML = scriptData[index - 1].text; 
        typing = false;
    }

        nextBtn.addEventListener("click", showNextLine);
        showNextLine();
    }

    // --- 'ìŠ¤í† ë¦¬ ì—´ëŒ' ë²„íŠ¼ í´ë¦­ ë¡œì§ (Fetch) ---
    readMoreLink.addEventListener('click', (event) => {
        event.preventDefault();
        const url = readMoreLink.href;

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => {
                storyViewContainer.innerHTML = html;
                storyContainer.classList.add('story-active');
                
                const vnContainer = storyViewContainer.querySelector('#vn-container');
                if (vnContainer) {
                    initializeVisualNovel(vnContainer);
                }
            })
            .catch(error => console.error('Error loading story:', error));
    });
});
</script>
{% endblock %}